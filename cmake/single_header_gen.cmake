message(STATUS "Greetings from the Single Header Creator")

function(strip_includes CONTENT DUMP)
    string(REGEX REPLACE "#ifndef [^\n]*\n#define [^\n]*\n" "" DUMP ${CONTENT})
    string(REGEX REPLACE "#ifndef [^\n]*\n" "" DUMP ${CONTENT})
endfunction()

function(fetch_sys_includes FILENAME)
    file(READ ${FILENAME} OUTPUT)
    string(REGEX MATCHALL "#include <[^>]*>" TO_DUMP ${OUTPUT})
    list(APPEND DUMP ${TO_DUMP})
    set(DUMP ${DUMP} PARENT_SCOPE)
endfunction()

function(get_name PATH)
    string(REGEX REPLACE "[^/]*/" "" NEW_NAME ${PATH})
    set(NEW_NAME ${NEW_NAME} PARENT_SCOPE)
endfunction()

function(get_header_define_naming VAL)
    string(TOUPPER ${VAL} HEADER_DEFINE_NAME)
    string(REPLACE "." "_" HEADER_DEFINE_NAME ${HEADER_DEFINE_NAME})
    set(HEADER_DEFINE_NAME ${HEADER_DEFINE_NAME} PARENT_SCOPE)
endfunction()

function(trim_content FILENAME SYS_INCLUDE DIR_INCLUDE)
    get_name(${FILENAME})
    get_header_define_naming(${NEW_NAME})
    file(READ "${PROJECT_SOURCE_DIR}/${FILENAME}" CONTENT)
    string(REGEX REPLACE "#ifndef OTIC_${HEADER_DEFINE_NAME}\n#define OTIC_${HEADER_DEFINE_NAME}\n" "" CONTENT "${CONTENT}")
    string(REGEX REPLACE "#endif //OTIC_${HEADER_DEFINE_NAME}" "" CONTENT "${CONTENT}")
    string(REGEX REPLACE "#ifdef __cplusplus\nextern \"C\" {\n#endif\n" "" CONTENT "${CONTENT}")
    string(REGEX REPLACE "#ifdef __cplusplus\n}\n#endif\n\n" "" CONTENT "${CONTENT}")
    string(REGEX REPLACE "#ifdef __cplusplus\n};\n#endif" "" CONTENT "${CONTENT}")

    foreach(V ${SYS_INCLUDE})
        string(REGEX REPLACE "${V}\n" "" CONTENT "${CONTENT}")
    endforeach()

    set(SOMETHING "#include \"config/config.h\"")
    string(REGEX REPLACE "#include \"[^\"]*\"" "" CONTENT "${CONTENT}")
    set(CONTENT "${CONTENT}" PARENT_SCOPE)
endfunction()


macro(generate_single_file FILENAME)
    message(STATUS "Generating: ${FILENAME}")
    set(FILE_PATH "${PROJECT_BINARY_DIR}/${FILENAME}")
    file(WRITE ${FILE_PATH} "#ifndef OTIC_H\n#define OTIC_H\n\n")
    file(APPEND ${FILE_PATH} "#ifdef __cplusplus\nextern \"C\" {\n#endif\n\n")
    set(INCLUDE_LIB_LIST "")
    foreach(FILE ${ARGN})
        fetch_sys_includes("${PROJECT_SOURCE_DIR}/${FILE}")
    endforeach()
    list(REMOVE_DUPLICATES DUMP)
    foreach (VAL ${DUMP})
        file(APPEND ${FILE_PATH} "${VAL}\n")
    endforeach ()

    file(APPEND ${FILE_PATH} "\n")

    foreach(VAL ${ARGN})
        trim_content("${VAL}" "${DUMP}" ${ARGN})
        file(APPEND "${FILE_PATH}" "${CONTENT}")
    endforeach()

    file(APPEND ${FILE_PATH} "\n#ifdef __cplusplus\n}\n#endif\n\n")
    file(APPEND ${FILE_PATH} "#endif //OTIC_H")
endmacro()